<style>
  .chart-container {
    width: 100%;
    max-width: 500px; /* Taille maximale du graphique */
    height: 300px; /* Hauteur fixe */
    margin: 0 auto; /* Centrer le graphique */
    display: block;
  }
</style>
{% extends "base.html" %}
{% block content %}

<!-- Container principal pour les statistiques -->
<div class="container mt-5">
  <!-- Titre de la page -->
  <h2>Statistiques</h2>

  <!-- Cartes de statistiques principales -->
  <div class="row mb-4">
    <!-- Tickets ouverts -->
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">Tickets ouverts</h5>
          <p class="card-text display-6">{{ stats.ouverts }}</p>
        </div>
      </div>
    </div>
    <!-- Tickets fermés -->
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">Tickets fermés</h5>
          <p class="card-text display-6">{{ stats.fermes }}</p>
        </div>
      </div>
    </div>
    <!-- Tickets en attente -->
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">Tickets en attente</h5>
          <p class="card-text display-6">{{ stats.attente }}</p>
        </div>
      </div>
    </div>
    <!-- Tickets urgents -->
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">Tickets urgents</h5>
          <p class="card-text display-6">{{ stats.urgents }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Graphique d'évolution des tickets -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Évolution des tickets</h5>
          <canvas id="ticketsChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Graphiques supplémentaires -->
  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Répartition des tickets</h5>
          <div class="chart-container">
            <canvas id="repartitionChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Tickets par technicien</h5>
          <canvas id="technicienChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Script Chart.js pour les graphiques -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Tickets Line Chart
  var ctx = document.getElementById('ticketsChart').getContext('2d');
  var ticketsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: {{ month_labels|safe }},
      datasets: [{
        label: 'Tickets créés',
        data: {{ month_counts|safe }},
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true
        }
      }
    }
  });

  // Répartition des tickets (Pie Chart)
  var repartitionCtx = document.getElementById('repartitionChart').getContext('2d');
  new Chart(repartitionCtx, {
    type: 'pie',
    data: {
      labels: {{ stat_labels|safe }},
      datasets: [{
        data: {{ stat_counts|safe }},
        backgroundColor: [
          'rgba(13,110,253,0.8)', // bleu
          'rgba(255,193,7,0.8)',  // jaune
          'rgba(25,135,84,0.8)'   // vert
        ],
        borderColor: [
          'rgba(13,110,253,1)',
          'rgba(255,193,7,1)',
          'rgba(25,135,84,1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true, // Maintenir le ratio d'aspect
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { enabled: true }
      },
      layout: { padding: 20 }
    }
  });

  // Technicien Bar Chart
  const techCtx = document.getElementById('technicienChart').getContext('2d');
  new Chart(techCtx, {
    type: 'bar',
    data: {
      labels: {{ tech_labels|safe }},
      datasets: [{
        label: 'Tickets',
        data: {{ tech_counts|safe }},
        backgroundColor: '#0d6efd',
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
</script>

{% endblock %}
