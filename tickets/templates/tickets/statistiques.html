<style>
  .chart-same-size {
    width: 100% !important;
    max-width: 500px;
    height: 300px !important;
    margin: 0 auto;
    display: block;
  }
  /* Nouvelle classe pour contrôler la hauteur du grand graphique */
  .chart-evolution {
    width: 100%;
    height: 360px; /* hauteur fixe pour éviter étirement vertical */
    max-height: 420px;
  }
</style>

{% extends "base.html" %}
{% block content %}
<h2 class="mb-4">Statistiques de la plateforme</h2>
<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="card shadow-sm text-center">
      <div class="card-body">
  <h5 class="card-title">Tickets total</h5>
  <p class="display-6 fw-bold" style="color:#2196f3;">{{ stats.ouverts|add:stats.fermes|add:stats.attente }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm text-center">
      <div class="card-body">
  <h5 class="card-title">Ouverts</h5>
  <p class="display-6 fw-bold" style="color:#00bcd4;">{{ stats.ouverts }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm text-center">
      <div class="card-body">
  <h5 class="card-title">Résolus</h5>
  <p class="display-6 fw-bold" style="color:#4caf50;">{{ stats.fermes }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm text-center">
      <div class="card-body">
  <h5 class="card-title">En attente</h5>
  <p class="display-6 fw-bold" style="color:#ffc107;">{{ stats.attente }}</p>
      </div>
    </div>
  </div>
</div>

<div class="row mt-5">
  <div class="col-md-6 mb-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Répartition des tickets par statut</h5>
        <canvas id="statutChart" class="chart-same-size"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Tickets par technicien</h5>
        <canvas id="technicienChart" class="chart-same-size"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-md-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">Évolution des tickets</h5>
          <div class="d-flex align-items-center">
            <div class="me-3 text-end">
                <div id="quickCount" class="display-6 fw-bold" style="color:#2196f3;">{{ tickets_this_month }}</div>
                <div id="quickLabel" style="font-size:0.9rem;color:#666;">Ce mois</div>
              </div>
            <select id="periodSelect" class="form-select w-auto">
              <option value="day">Derniers 30 jours</option>
              <option value="month" selected>12 derniers mois</option>
              <option value="year">5 dernières années</option>
            </select>
          </div>
        </div>
        <canvas id="evolutionChart" class="chart-evolution"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Statut Doughnut Chart
const statutCtx = document.getElementById('statutChart').getContext('2d');
new Chart(statutCtx, {
  type: 'doughnut',
  data: {
    labels: {{ stat_labels|safe }},
    datasets: [{
      data: {{ stat_counts|safe }},
      backgroundColor: [
        'rgba(13,110,253,0.8)', // bleu
        'rgba(255,193,7,0.8)',  // jaune
        'rgba(25,135,84,0.8)'   // vert
      ],
      borderColor: [
        'rgba(13,110,253,1)',
        'rgba(255,193,7,1)',
        'rgba(25,135,84,1)'
      ],
      borderWidth: 2
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom' },
      tooltip: { enabled: true }
    },
    layout: { padding: 20 }
  }
});

// Technicien Bar Chart
const techCtx = document.getElementById('technicienChart').getContext('2d');
new Chart(techCtx, {
    type: 'bar',
    data: {
        labels: {{ tech_labels|safe }},
        datasets: [{
            label: 'Tickets',
            data: {{ tech_counts|safe }},
            backgroundColor: '#0d6efd',
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
    }
});

// Evolution Line Chart
const evolCtx = document.getElementById('evolutionChart').getContext('2d');
// Créer un chart dynamique qui peut afficher jour/mois/année
const datasets = {
  day: {
    labels: {{ day_labels|safe }},
    data: {{ day_counts|safe }},
    label: 'Tickets créés (jours)'
  },
  month: {
    labels: {{ month_labels|safe }},
    data: {{ month_counts|safe }},
    label: 'Tickets créés (mois)'
  },
  year: {
    labels: {{ year_labels|safe }},
    data: {{ year_counts|safe }},
    label: 'Tickets créés (années)'
  }
};

let currentPeriod = document.getElementById('periodSelect').value;

const evolChart = new Chart(evolCtx, {
    type: 'line',
    data: {
        labels: datasets[currentPeriod].labels,
        datasets: [{
            label: datasets[currentPeriod].label,
            data: datasets[currentPeriod].data,
            borderColor: '#198754',
            backgroundColor: 'rgba(25,135,84,0.2)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        plugins: { legend: { position: 'bottom' } },
        scales: { y: { beginAtZero: true } },
        responsive: true,
        maintainAspectRatio: false
    }
});

// Met à jour le graphique lorsque la sélection change
document.getElementById('periodSelect').addEventListener('change', function(e) {
  const p = e.target.value;
  evolChart.data.labels = datasets[p].labels;
  evolChart.data.datasets[0].data = datasets[p].data;
  evolChart.data.datasets[0].label = datasets[p].label;
  evolChart.update();
  // Met à jour le compteur rapide affiché
  if(p === 'day') {
    document.getElementById('quickCount').innerText = {{ tickets_today }};
    document.getElementById('quickLabel').innerText = "Aujourd'hui";
  } else if(p === 'month') {
    document.getElementById('quickCount').innerText = {{ tickets_this_month }};
    document.getElementById('quickLabel').innerText = "Ce mois";
  } else if(p === 'year') {
    document.getElementById('quickCount').innerText = {{ tickets_this_year }};
    document.getElementById('quickLabel').innerText = "Cette année";
  }
});

// Initialisation du quickCount au chargement
document.addEventListener('DOMContentLoaded', function(){
  const sel = document.getElementById('periodSelect').value;
  if(sel === 'day') document.getElementById('quickCount').innerText = {{ tickets_today }};
  if(sel === 'month') document.getElementById('quickCount').innerText = {{ tickets_this_month }};
  if(sel === 'year') document.getElementById('quickCount').innerText = {{ tickets_this_year }};
});
</script>

{% endblock %}
